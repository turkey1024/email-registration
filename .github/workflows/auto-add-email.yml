name: Auto Add Email Forwarding
on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  process-email:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR changes
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0  # è·å–å®Œæ•´æäº¤å†å²

      - name: Find new JSON files
        id: find-json
        run: |
          echo "json_files=$(find registrations/ -name '*.json')" >> $GITHUB_OUTPUT

      - name: Validate and process registrations
        if: steps.find-json.outputs.json_files != ''
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
        run: |
          # åˆå§‹åŒ–å˜é‡
          declare -A email_count
          failed_checks=0
          added_rules=0

          # å¤„ç†æ¯ä¸ªJSONæ–‡ä»¶
          for file in ${{ steps.find-json.outputs.json_files }}; do
            echo "ğŸ” æ­£åœ¨å¤„ç†æ–‡ä»¶: $file"
            prefix=$(basename "$file" .json)
            email=$(jq -r '.email' "$file")

            # ---- éªŒè¯1ï¼šå‰ç¼€æ ¼å¼æ£€æŸ¥ ----
            if [[ ! "$prefix" =~ ^[a-z0-9-]{1,20}$ ]]; then
              echo "âŒ é”™è¯¯: å‰ç¼€ '$prefix' åªèƒ½åŒ…å«å°å†™å­—æ¯ã€æ•°å­—å’ŒçŸ­æ¨ªçº¿ï¼Œä¸”é•¿åº¦1-20å­—ç¬¦"
              ((failed_checks++))
              continue
            fi

            # ---- éªŒè¯2ï¼šé‚®ç®±æ ¼å¼æ£€æŸ¥ ----
            if [[ ! "$email" =~ ^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$ ]]; then
              echo "âŒ é”™è¯¯: '$email' ä¸æ˜¯æœ‰æ•ˆçš„é‚®ç®±åœ°å€"
              ((failed_checks++))
              continue
            fi

            # ---- éªŒè¯3ï¼šæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒå‰ç¼€ ----
            existing_rule=$(curl -s -X GET \
              "https://api.cloudflare.com/client/v4/zones/$CLOUDFLARE_ZONE_ID/email/routing/rules" \
              -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" | \
              jq --arg p "$prefix@qxz.qzz.io" '.result[] | select(.matchers[0].type=="literal" and .matchers[0].value==$p)')

            if [ -n "$existing_rule" ]; then
              echo "âš ï¸ è­¦å‘Š: å‰ç¼€ '$prefix' å·²å­˜åœ¨ï¼Œè·³è¿‡æ·»åŠ "
              continue
            fi

            # ---- éªŒè¯4ï¼šå•ç”¨æˆ·æœ€å¤š3ä¸ªæ³¨å†Œ ----
            email_count["$email"]=$((email_count["$email"] + 1))
            if [ ${email_count["$email"]} -gt 3 ]; then
              echo "âŒ é”™è¯¯: é‚®ç®± '$email' å·²æ³¨å†Œè¶…è¿‡3ä¸ªå‰ç¼€"
              ((failed_checks++))
              continue
            fi

            # ---- æ·»åŠ åˆ°Cloudflare ----
            echo "âœ… éªŒè¯é€šè¿‡: $prefix@qxz.qzz.io â†’ $email"
            response=$(curl -s -X POST \
              "https://api.cloudflare.com/client/v4/zones/$CLOUDFLARE_ZONE_ID/email/routing/rules" \
              -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
              -H "Content-Type: application/json" \
              --data '{
                "matchers": [{
                  "type": "literal",
                  "field": "to",
                  "value": "'"$prefix"'@qxz.qzz.io"
                }],
                "actions": [{
                  "type": "forward",
                  "value": ["'"$email"'"]
                }],
                "priority": 10,
                "enabled": true,
                "tags": ["auto-generated"]
              }')

            # æ£€æŸ¥APIå“åº”
            if [[ $(echo "$response" | jq -r '.success') == "true" ]]; then
              echo "ğŸ‰ æˆåŠŸæ·»åŠ è§„åˆ™: $(echo "$response" | jq -r '.result.id')"
              ((added_rules++))
            else
              echo "âŒ APIé”™è¯¯: $(echo "$response" | jq -r '.errors[0].message')"
              ((failed_checks++))
            fi
          done

          # ç»“æœæ±‡æ€»
          echo "========================================"
          echo "ğŸ“Š è§„åˆ™å¤„ç†ç»“æœ:"
          echo "âœ… æˆåŠŸæ·»åŠ : $added_rules æ¡"
          echo "âŒ å¤±è´¥æ£€æŸ¥: $failed_checks æ¡"
          
          # å¦‚æœæœ‰å¤±è´¥åˆ™ç»ˆæ­¢æµç¨‹
          if [ $failed_checks -ne 0 ]; then
            echo "::error::å‘ç° $failed_checks ä¸ªé”™è¯¯ï¼Œè¯·æ£€æŸ¥PRå†…å®¹"
            exit 1
          fi

      - name: æ¸…ç†æ—§è§„åˆ™ï¼ˆå¯é€‰ï¼‰
        if: always()
        run: |
          # åˆ é™¤æ ‡è®°ä¸º auto-generated çš„æ—§è§„åˆ™ï¼ˆç¤ºä¾‹ï¼‰
          echo "è‹¥è¦å¯ç”¨è‡ªåŠ¨æ¸…ç†ï¼Œè¯·å–æ¶ˆæ³¨é‡Šä»¥ä¸‹ä»£ç "
          # curl -s -X GET "https://api.cloudflare.com/client/v4/zones/$CLOUDFLARE_ZONE_ID/email/routing/rules" \
          #   -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" | \
          #   jq -r '.result[] | select(.tags[]? | contains("old-tag")) | .id' | \
          #   xargs -I {} curl -X DELETE \
          #   "https://api.cloudflare.com/client/v4/zones/$CLOUDFLARE_ZONE_ID/email/routing/rules/{}" \
          #   -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN"
