name: Auto Add Email Forwarding
on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  process-email:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Process email rules
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
        run: |
          # å¤„ç†æ‰€æœ‰registrations/ä¸‹çš„jsonæ–‡ä»¶
          for file in $(find registrations/ -name '*.json'); do
            echo "ğŸ” Processing: $file"
            
            # æå–é‚®ç®±ï¼ˆå…è®¸æœ€ç®€æ ¼å¼{"email":"x@x.com"}ï¼‰
            email=$(jq -r '.email | select(.!=null)' "$file" 2>/dev/null)
            if [ -z "$email" ]; then
              echo "âŒ é”™è¯¯ï¼šæ–‡ä»¶ $file ç¼ºå°‘æœ‰æ•ˆçš„emailå­—æ®µ"
              continue
            fi

            # éªŒè¯é‚®ç®±æ ¼å¼
            if [[ ! "$email" =~ ^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$ ]]; then
              echo "âŒ é”™è¯¯ï¼š'$email' ä¸æ˜¯æœ‰æ•ˆçš„é‚®ç®±åœ°å€"
              continue
            fi

            # ä½¿ç”¨æ–‡ä»¶åä½œä¸ºå‰ç¼€ï¼ˆè‡ªåŠ¨è½¬å°å†™å¹¶è¿‡æ»¤ç‰¹æ®Šå­—ç¬¦ï¼‰
            prefix=$(basename "$file" .json | tr '[:upper:]' '[:lower:]' | tr -cd 'a-z0-9-')
            if [ -z "$prefix" ]; then
              echo "âŒ é”™è¯¯ï¼šæ–‡ä»¶åæ— æ•ˆï¼ˆåªèƒ½åŒ…å«å­—æ¯æ•°å­—å’ŒçŸ­æ¨ªçº¿ï¼‰"
              continue
            fi

            # æ·»åŠ Cloudflareè½¬å‘è§„åˆ™
            echo "âœ… æ·»åŠ : $prefix@qxz.qzz.io â†’ $email"
            response=$(curl -s -X POST \
              "https://api.cloudflare.com/client/v4/zones/$CLOUDFLARE_ZONE_ID/email/routing/rules" \
              -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
              -H "Content-Type: application/json" \
              --data '{
                "matchers": [{
                  "type": "literal",
                  "field": "to",
                  "value": "'"$prefix"'@qxz.qzz.io"
                }],
                "actions": [{
                  "type": "forward",
                  "value": ["'"$email"'"]
                }]
              }')

            # æ£€æŸ¥APIå“åº”
            if [[ $(echo "$response" | jq -r '.success') != "true" ]]; then
              echo "âŒ APIé”™è¯¯: $(echo "$response" | jq -r '.errors[0].message')"
            else
              echo "ğŸ‰ æˆåŠŸæ·»åŠ è§„åˆ™ID: $(echo "$response" | jq -r '.result.id')"
            fi
          done

